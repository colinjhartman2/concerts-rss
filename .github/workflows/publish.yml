name: Build & Publish RSS

on:
  schedule:
    - cron: "0 16 * * *"   # 09:00 AM PT (16:00 UTC) â€“ adjust if needed
    - cron: "0 4  * * *"   # 09:00 PM PT (04:00 UTC next day)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -r requirements.txt

      - name: Run collector
        env:
          TICKETMASTER_API_KEY: ${{ secrets.TICKETMASTER_API_KEY }}
        run: |
          # write key into config if you prefer env var approach; for simplicity we can sed it in
          python -c "from pathlib import Path; p=Path('src/config.py'); s=p.read_text(); s=s.replace('YOUR_TICKETMASTER_KEY', '${{ secrets.TICKETMASTER_API_KEY }}'); p.write_text(s)"
          python src/main.py

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: rss
          path: docs/*.xml

      - name: Commit RSS to docs/
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/*.xml events.db || true
          git commit -m "Update RSS feeds" || echo "No changes"
          git push

  pages:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
